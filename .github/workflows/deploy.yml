name: Deploy to DigitalOcean App Platform

on:
  push:
    branches: [ main, staging ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: registry.digitalocean.com
  IMAGE_NAME: habilitacion-llm-agents

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests
      run: |
        cd backend
        python -m pytest tests/ -v || echo "No tests found, continuing..."

    - name: Lint with flake8
      run: |
        cd backend
        pip install flake8
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create .do directory
      run: mkdir -p .do

    - name: Generate app.yaml
      run: |
        cat > .do/app.yaml << EOF
        name: habilitacion-llm-agents
        services:
        - name: api
          source_dir: backend
          github:
            repo: ceo-exltk/habilitacion-llm
            branch: main
          run_command: uvicorn api.main:app --host 0.0.0.0 --port \$PORT
          environment_slug: python
          instance_count: 1
          instance_size_slug: basic-xxs
          http_port: 8080
          envs:
          - key: DO_GRADIENT_INFERENCE_KEY
            value: \${{ secrets.DO_GRADIENT_INFERENCE_KEY }}
            scope: RUN_AND_BUILD_TIME
          - key: GRADIENT_BASE_URL
            value: https://inference.do-ai.run
            scope: RUN_AND_BUILD_TIME
          - key: GRADIENT_MODEL
            value: openai-gpt-oss-120b
            scope: RUN_AND_BUILD_TIME
          - key: SUPABASE_URL
            value: \${{ secrets.SUPABASE_URL }}
            scope: RUN_AND_BUILD_TIME
          - key: SUPABASE_ANON_KEY
            value: \${{ secrets.SUPABASE_ANON_KEY }}
            scope: RUN_AND_BUILD_TIME
          - key: SUPABASE_SERVICE_KEY
            value: \${{ secrets.SUPABASE_SERVICE_KEY }}
            scope: RUN_AND_BUILD_TIME
            type: SECRET
          - key: SECRET_KEY
            value: \${{ secrets.SECRET_KEY }}
            scope: RUN_AND_BUILD_TIME
          - key: DEBUG
            value: false
            scope: RUN_AND_BUILD_TIME
          - key: LOG_LEVEL
            value: INFO
            scope: RUN_AND_BUILD_TIME
          health_check:
            http_path: /health
            initial_delay_seconds: 10
            period_seconds: 10
            timeout_seconds: 5
            success_threshold: 1
            failure_threshold: 3
          routes:
          - path: /
            component:
              name: api
              preserve_path_prefix: false
          - path: /api
            component:
              name: api
              preserve_path_prefix: true
          - path: /docs
            component:
              name: api
              preserve_path_prefix: true
          - path: /redoc
            component:
              name: api
              preserve_path_prefix: true
          - path: /health
            component:
              name: api
              preserve_path_prefix: true
          - path: /api/v1/agent
            component:
              name: api
              preserve_path_prefix: true
        region: atl
        features:
        - buildpack-stack=ubuntu-22
        EOF

    - name: Deploy to DigitalOcean App Platform
      uses: digitalocean/app_action/deploy@v2
      with:
        token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
        app_name: habilitacion-llm-agents
        spec_file: .do/app.yaml

    - name: Wait for deployment
      run: |
        echo "Waiting for deployment to complete..."
        sleep 30

    - name: Test deployment
      run: |
        # Get the app URL from DigitalOcean
        APP_URL=$(doctl apps get habilitacion-llm-agents --format "Spec.Services[0].Routes[0].Path" --no-header 2>/dev/null || echo "")
        if [ -n "$APP_URL" ]; then
          echo "Testing health endpoint..."
          curl -f "$APP_URL/health" || echo "Health check failed"
        else
          echo "Could not determine app URL"
        fi

  notify:
    needs: [test, build-and-deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Notify deployment status
      run: |
        if [ "${{ needs.build-and-deploy.result }}" == "success" ]; then
          echo "✅ Deployment successful!"
        else
          echo "❌ Deployment failed!"
        fi
